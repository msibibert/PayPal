<!doctype html>
<html>
  <head>
    <meta charset="utf-8"><title>Return Host</title>
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
      body{font-family:-apple-system,system-ui,Arial;padding:24px}
      .badge{display:inline-block;padding:6px 10px;border-radius:8px;background:#fee2e2;color:#991b1b;font-weight:700}
      .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    </style>
  </head>
  <body>
    <div class="badge">/return page</div>
    <div style="margin-top:12px" class="mono" id="info"></div>

    <script>
      (function () {
        const params = new URLSearchParams(location.search);
        const token = params.get('token') || '';
        const mode  = params.get('mode') || 'bug';
        const hasOpener = !!window.opener;
        const info = document.getElementById('info');
        info.textContent = `href=${location.href}\nmode=${mode}\nopener=${hasOpener}\ntoken=${token}`;

        // Нормальный веб: отправляем сообщение родителю и закрываем окно/вкладку
        if (hasOpener) {
          try { window.opener.postMessage('paypal-approved', '*'); } catch (e) {}
          try { window.close(); } catch (e) {}
        }
        // Если opener нет (типично для iOS ASWebAuth), НИЧЕГО не делаем — это и есть баговый сценарий.
      })();
    </script>

    <p style="margin-top:16px">
      На рабочем вебе в этот момент родительская страница получает <code>postMessage</code> и рисует модалку «Processing…».
      В in-app (ASWebAuthenticationSession) <code>opener === false</code>, поэтому родитель не узнаёт о возврате.
    </p>
  </body>
</html>