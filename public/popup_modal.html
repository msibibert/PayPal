<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Repro: PayPal popup -> modal -> deeplink</title>
    <style>
      body { font-family: -apple-system, system-ui, Arial; padding: 24px; }
      #log { white-space: pre-wrap; background: #f6f6f6; padding: 12px; border-radius: 8px; }
      .overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.98);
        display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 9999; }
      .spinner { width: 48px; height: 48px; border: 4px solid #e5e7eb; border-top-color: #2563eb;
        border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
      @keyframes spin { to { transform: rotate(360deg) } }
      .btn { background:#2563eb; color:#fff; border:0; padding:10px 16px; border-radius:8px; cursor:pointer; }
      .muted { color:#6b7280; font-size:14px; margin-top:8px; text-align:center; max-width: 300px; }
    </style>
  </head>
  <body>
    <h3>POPUP → loader modal → deeplink (как на их сайте)</h3>
    <p>Кнопка открывает PayPal <b>в попапе</b>. После закрытия попапа показываем модалку и вызываем диплинк.</p>
    <button id="pay" class="btn">Pay (popup)</button>
    <pre id="log"></pre>

    <div id="overlay" class="overlay">
      <div class="spinner"></div>
      <div id="statusText">Processing your order...</div>
      <button id="returnBtn" class="btn" style="margin-top:16px;">Return to the app</button>
      <div class="muted">If it doesn’t return automatically, tap the button.</div>
    </div>

    <script>
      const logEl = document.getElementById('log');
      const overlay = document.getElementById('overlay');
      const returnBtn = document.getElementById('returnBtn');
      const APP_SCHEME_BASE = 'screwfixapp://order-confirmation';

      const log = (m) => logEl.textContent += m + '\n';

      document.getElementById('pay').addEventListener('click', async () => {
        log('create-order...');
        const r = await fetch('/create-order', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({})
        });
        const j = await r.json();
        log('approvalUrl: ' + j.approvalUrl + '\norderId: ' + j.orderId);

        // Открываем PayPal в ПОПАПЕ (корень проблемы)
        const win = window.open(j.approvalUrl, '_blank', 'width=420,height=720');

        // Ждём закрытия попапа (в in-app браузере это часто «белое окно»)
        let ticks = 0;
        const poll = setInterval(() => {
          ticks++;
          let closed = false;
          try { closed = !win || win.closed; } catch(e){ /* ignore */ }
          if (closed || ticks > 1200) { // safety
            clearInterval(poll);
            showModal(j.orderId);
          }
        }, 500);
      });

      function showModal(orderId){
        log('popup closed -> show loader modal');
        overlay.style.display = 'flex';

        // Авто-вызов диплинка через небольшую задержку (как у них)
        setTimeout(() => {
          const deeplink = `${APP_SCHEME_BASE}?id=${encodeURIComponent(orderId)}`;
          log('AUTO deeplink → ' + deeplink);
          try { window.location.href = deeplink; } catch(e){}
        }, 1200);

        // Кнопка "Return to app" — ручной вызов диплинка
        returnBtn.onclick = () => {
          const deeplink = `${APP_SCHEME_BASE}?id=${encodeURIComponent(orderId)}`;
          log('BUTTON deeplink → ' + deeplink);
          try { window.location.href = deeplink; } catch(e){}
        };
      }
    </script>
  </body>
</html>