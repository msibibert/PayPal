<script>
  const logEl = document.getElementById('log');
  const overlay = document.getElementById('overlay');
  const returnBtn = document.getElementById('returnBtn');
  const APP_SCHEME_BASE = 'screwfixapp://order-confirmation';

  const log = (m) => (logEl.textContent += m + '\n');

  let lastOrderId = null;

  // Единственный триггер успеха — сообщение от /return
  window.addEventListener('message', (ev) => {
    if (ev.data === 'paypal-approved') {
      log('message: paypal-approved (got from /return)');
      showModal(lastOrderId);           // показать модалку
    }
  });

  document.getElementById('pay').addEventListener('click', async () => {
    log('create-order...');
    const r = await fetch('/create-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    const j = await r.json();
    lastOrderId = j.orderId;

    log('approvalUrl: ' + j.approvalUrl + '\norderId: ' + j.orderId);

    // Открываем отдельное окно (в браузерах: есть window.opener у /return)
    const w = 480, h = 720;
    const left = Math.max(0, (window.screen.width - w) / 2);
    const top  = Math.max(0, (window.screen.height - h) / 2);

    const win = window.open(
      j.approvalUrl,
      '_blank',
      `popup=yes,width=${w},height=${h},left=${left},top=${top},` +
      `toolbar=0,location=0,menubar=0,status=0,scrollbars=1,resizable=1`
    );

    if (!win) {
      log('popup blocked -> same-tab fallback (в браузере всё равно придёт message)');
      window.top.location.href = j.approvalUrl;
    }
  });

  function showModal(orderId) {
    if (!orderId) return;
    log('show loader modal');               // модалка только после message
    overlay.style.display = 'flex';

    // диплинк уходит только из модалки родителя (как у них)
    setTimeout(() => {
      const deeplink = `${APP_SCHEME_BASE}?id=${encodeURIComponent(orderId)}`;
      log('AUTO deeplink → ' + deeplink);
      try { window.location.href = deeplink; } catch(e){}
    }, 800);

    returnBtn.onclick = () => {
      const deeplink = `${APP_SCHEME_BASE}?id=${encodeURIComponent(orderId)}`;
      log('BUTTON deeplink → ' + deeplink);
      try { window.location.href = deeplink; } catch(e){}
    };
  }
</script>